{"version":3,"sources":["../../src/lib/debug.js"],"names":[],"mappings":"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","file":"debug.js","sourcesContent":["/*\n * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED\n * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES\n * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE\n * DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT,\n * INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES\n * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR\n * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)\n * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,\n * STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING\n * IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE\n * POSSIBILITY OF SUCH DAMAGE.\n */\n\nimport {Debugger} from 'yadc'\n\nexport default () => {\n  let raw\n  let seq = 0\n  const scriptIdToUrl = new Map\n\n  const scripts = cb => {\n    raw.send({\n      seq: ++seq,\n      type: 'request',\n      command: 'scripts',\n      arguments: {\n        types: 4,\n        includeSource: true\n      } \n    }, (err, scripts) => {\n      if (err) return cb(err)\n      if (!scripts.res) return cb(Error('no response'))\n      const {res} = scripts\n      if (!res.body) return cb(Error('no scripts'))\n      res.body.forEach(({id, name}) => scriptIdToUrl.set(id, name))\n      cb(null, res.body)\n    })\n  }\n\n  const backtrace = cb => {\n    raw.send({\n      seq: ++seq,\n      type: 'request',\n      command: 'backtrace',\n      arguments: {\n        inlineRefs: true,\n        fromFrame: 0,\n        maxStringLength: 10000\n      }\n    }, (err, bt) => {\n      if (err) return cb(err)\n      if (!bt.res) return cb(Error('no response'))\n      const {res} = bt\n      if (!res.body) return cb(Error('no backtrace'))\n      cb(null, res.body)\n    })\n  }\n\n  const breakpoints = cb => {\n    raw.send({\n      seq: ++seq,\n      type: 'request',\n      command: 'listbreakpoints'\n    }, (err, breakpoints) => {\n      if (err) return cb(err)\n      if (!breakpoints.res) return cb(Error('no response'))\n      const {res} = breakpoints\n      if (!res.body) return cb(Error('no breakpoints'))\n      res.body.breakpoints = res.body.breakpoints.filter(bp => bp.type === 'scriptName')\n      cb(null, res.body)\n    })\n  }\n\n  const setBreakpoint = ({line, file:target}, cb) => {\n    raw.send({\n      seq: ++seq,\n      type: 'request',\n      command: 'setbreakpoint',\n      arguments: {\n        type: 'script', target, line\n      }\n    }, (err, breakpoint) => {\n      if (err) return cb(err)\n      if (!breakpoint.res) return cb(Error('no response'))\n      const {res} = breakpoint\n      if (!res.body) return cb(Error('unable to set breakpoint'))\n      cb(null, res.body)\n    })\n  }\n\n  const clearBreakpoint = (breakpoint, cb) => {\n    raw.send({\n      seq: ++seq,\n      type: 'request',\n      command: 'clearbreakpoint',\n      arguments: {\n        type: 'script',\n        breakpoint\n      }\n    }, (err, breakpoint) => {\n      if (err) return cb(err)\n      if (!breakpoint.res) return cb(Error('no response'))\n      const {res} = breakpoint\n      if (!res.body) return cb(Error('unable to unset breakpoint'))\n      cb(null, res.body)\n    })\n  }\n\n  const step = (cb=()=>{}) => {\n    raw.send({\n      seq: ++seq,\n      type: 'request',\n      command: 'continue',\n      arguments: {\n        stepaction: 'next'\n      }\n    }, (err) => {\n      if (err) return cb(err)\n      callstack(cb)\n    })\n  }\n\n  const resume = (cb=()=>{}) => {\n    raw.send({\n      seq: ++seq,\n      type: 'request',\n      command: 'continue',\n    }, (err) => {\n      if (err) return cb(err)\n      cb()\n    })\n  }\n\n  const pause = (cb=()=>{}) => {\n    raw.send({\n      seq: ++seq,\n      type: 'request',\n      command: 'suspend',\n    }, (err) => {\n      if (err) return cb(err)\n      callstack(cb)\n    })\n  }\n\n  const callstack = cb => backtrace((err, {frames, totalFrames}) => {\n    if (err) return cb(err)\n    if (totalFrames === 0) { return cb() }\n    if (scriptIdToUrl.size) { return fetch() }\n\n    //populate scripts cache\n    scripts(fetch)\n    \n    function fetch () {\n      cb(null, frames.map(({index, func, line, column}) => ({\n        callFrameId: index,\n        functionName: func.inferredName || func.name,\n        location: {\n          scriptId: func.scriptId,\n          lineNumber: line,\n          columnNumber: column,\n          url: scriptIdToUrl.get(func.scriptId)\n        }\n      })))\n    }\n  })\n  \n  const start = (debugPort = 5858, cb) => {\n\n    raw = new Debugger({port: debugPort, host: 'localhost'})\n    raw.connect(() => callstack(cb))\n\n  }\n\n  // const evaluate = (expression, cb) => {\n  //   let value\n  //   let type = 'object'\n  //   const opts = {\n  //     expression, \n  //     callFrameId: currentContext.bp.callFrames[0].callFrameId\n  //   }\n\n  //   dbg.evaluateOnCallFrame(opts, (err, result) => {\n  //     if (err) { return cb(err) }\n\n  //     if (result.result.type === 'object') {\n  //       const opts = {\n  //         expression: 'JSON.stringify(' + expression + ')', \n  //         callFrameId: currentContext.bp.callFrames[0].callFrameId\n  //       }\n  //       dbg.evaluateOnCallFrame(opts, (err, {result:{result}}) => {\n  //         if (err) { return cb(err) }\n  //         try {\n  //           value = JSON.parse(result.description)\n  //         }\n  //         catch (e) {\n  //           value = result.description\n  //           type = 'string'\n  //         }\n  //         cb(null, {type: type, value: value})\n  //       });\n  //     }\n  //     else {\n  //       cb(null, {type: result.type, value: result.description})\n  //     }\n  //   })\n  // }\n\n\n  return {\n    scripts,\n    start,\n    breakpoints,\n    resume,\n    pause,\n    // evaluate,\n    setBreakpoint,\n    clearBreakpoint,\n    step\n  }\n} \n"]}